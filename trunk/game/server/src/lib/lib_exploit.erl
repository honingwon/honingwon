%% Author: wangdahai
%% Created: 2013-5-2
%% Description: TODO: Add description to lib_exploint
-module(lib_exploit).

%%
%% Include files
%%
-include("common.hrl").
%%
%% Exported Functions
%%
-export([get_user_exploit/1, pvp1_add_exploit/2, add_exploit/2]).
-define(MAX_PVP1_AWARD, 60).%%pvp单挑王获得奖励
%%
%% API Functions
%%

%% 数据库中获取玩家功勋信息
get_user_exploit({UserID,Now}) ->
	Exploit = case db_agent_user:get_user_exploit(UserID) of
			[] ->
				#user_exploit_info{user_id = UserID};
			Info ->
				list_to_tuple([user_exploit_info] ++ Info)
	end,
	
	Day = misc_timer:get_day(Now),
	AchieveDay = misc_timer:get_day(Exploit#user_exploit_info.achieve_time),
	%?DEBUG("get_user_exploit:~p",[{Day,AchieveDay}]),
	if
		Exploit#user_exploit_info.achieve_time  =:= 0 ->
			Exploit1 = Exploit;
		AchieveDay =/= Day ->%%需要清空其它单天统计数据
			Exploit1 = Exploit#user_exploit_info{pvp1_day_award = 0, achieve_time = 0},
			db_agent_user:update_user_exploit(UserID, Exploit1);
		true ->
			Exploit1 = Exploit			
	end,
	Exploit1.

add_exploit(Exploit, Point) ->
	NewExploit = Exploit#user_exploit_info{exploit =  Exploit#user_exploit_info.exploit + Point},
	db_agent_user:update_user_exploit(NewExploit#user_exploit_info.user_id, NewExploit),
	NewExploit.

pvp1_add_exploit(Exploit, Value) ->
	Now = misc_timer:now_seconds(),
	Day = misc_timer:get_day(Now),
	AchieveDay = misc_timer:get_day(Exploit#user_exploit_info.achieve_time),
	if		
		Day =/= AchieveDay ->%%需要清空其它单天统计数据
			NewExploit = Exploit#user_exploit_info{exploit =  Exploit#user_exploit_info.exploit + Value,
													pvp1_day_award = Value,
													achieve_time = Now},
			db_agent_user:update_user_exploit(NewExploit#user_exploit_info.user_id, NewExploit),
			{ok,NewExploit};
		Exploit#user_exploit_info.pvp1_day_award >= ?MAX_PVP1_AWARD ->
			{false};
		true ->
			NewExploit = Exploit#user_exploit_info{exploit =  Exploit#user_exploit_info.exploit + Value,
													pvp1_day_award =  Exploit#user_exploit_info.pvp1_day_award + Value,
													achieve_time = Now},
			db_agent_user:update_user_exploit(NewExploit#user_exploit_info.user_id, NewExploit),
			{ok,NewExploit}
	end.
%%
%% Local Functions
%%

