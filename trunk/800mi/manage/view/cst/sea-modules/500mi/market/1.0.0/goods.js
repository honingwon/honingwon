define(function(require){var e=require("cart"),t=require("$"),n=require("backbone"),r=require("underscore");require("localStorage");var i=n.Model.extend({defaults:function(){return{id:0,goods_barcode:0,goods_name:"",goods_weight:"",goods_pic_url:"",goods_active_price:0,goods_unit:"",amount:1}},setAmount:function(e){var t=e;t<1&&(t=1),e<1&&this.set({amount:0},{silent:!0}),this.set({amount:t})},increase:function(){var e=this.get("amount");e++,this.set({amount:e})},decrease:function(){var e=this.get("amount");e--,e<1&&(e=1),this.set({amount:e})}}),s=n.Collection.extend({model:i}),o=n.Model.extend({url:"/view/model/BMManage/GoodsManageMethod.php",query:{lv:TYPE_ID_LEVEL,type3Id:TYPE_ID,offset:0,pageSize:PAGE_SIZE,brandId:BRAND_ID,method:"List",t:(new Date).getTime()}}),u=new s,a=new o,f=n.View.extend({tagName:"li",template:r.template(t("#goods-template").html()),events:{"click .btn-plus":"increase","click .btn-minus":"decrease","change input[type='text']":"setAmount","click .b-favorite":"favoriteIt","click .b-blue":"buyIt"},initialize:function(){this.listenTo(this.model,"change:amount",this.amountChanged)},amountChanged:function(){this.$input.val(this.model.get("amount"))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$input=this.$("input[type='text']"),this},increase:function(){this.model.increase()},decrease:function(){this.model.decrease()},setAmount:function(){var e=this.$input.val();this.model.setAmount(e)},favoriteIt:function(){console.log(this.model)},buyIt:function(){if(!r.include(e.localStorage.records,this.model.id.toString()))e.create(r.clone(this.model.attributes));else{var t=e.get(this.model.id);t.setAmount(parseInt(t.get("amount"))+parseInt(this.$input.val()),!0)}}}),l=n.View.extend({el:t("#market"),events:{"click #page a":"changePage"},initialize:function(){this.listenTo(u,"add",this.addToGoodsList),this.listenTo(a,"sync",this.marketUpdate),this.getData()},changePage:function(e){console.log(e)},marketUpdate:function(e){u.set([]),u.set(e.get("DataList"),{})},addToGoodsList:function(e){var t=new f({model:e});this.$("#goods-list").append(t.render().el)},getData:function(){t("#market").addClass("loading-goods"),t("#goods-list").html(""),t("#page").html(""),a.fetch({data:a.query,success:function(e,n,r){t("#market").removeClass("loading-goods")},error:function(e,n,r){t("#market").removeClass("loading-goods")}})}}),o=new l})