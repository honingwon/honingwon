define(function(require,e,t){var n=require("$"),r=require("backbone"),i=require("underscore");require("localStorage");var s='<img src="<%- goods_pic_url %>"><h3><%- goods_name %></h3><div class="op-amount">	<input type="text" value="<%- amount %>" maxlength="4">	<a class="btn-plus" href="javascript:;" title="增加物品">+</a>	<a class="btn-minus" href="javascript:;" title="减少物品">-</a></div><p><em>￥<%- goods_active_price %></em><a class="destroy" href="javascript:;">删除</a></p>',o=r.Model.extend({defaults:function(){return{id:0,goods_barcode:0,goods_name:"",goods_weight:"",goods_pic_url:"",goods_active_price:0,goods_unit:"",amount:1}},setAmount:function(e){var t=e;t<1&&(t=1),e<1&&this.save({amount:0},{silent:!0}),this.save({amount:t})},increase:function(){var e=this.get("amount");e++,this.save({amount:e})},decrease:function(){var e=this.get("amount");e--,e<1&&(e=1),this.save({amount:e})},calc:function(){return this.get("goods_price")*this.get("amount")}}),u=r.Collection.extend({model:o,localStorage:new r.LocalStorage("cart"),calc:function(){var e=0;return this.each(function(t){e+=t.calc()}),e}}),a=new u,f=r.View.extend({tagName:"li",template:i.template(s),events:{"click .destroy":"clear","click .btn-plus":"increase","click .btn-minus":"decrease",'change input[type="text"]':"setAmount"},initialize:function(){this.listenTo(this.model,"change:amount",this.amountChanged),this.listenTo(this.model,"destroy",this.remove)},amountChanged:function(){this.$input.val(this.model.get("amount"))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$input=this.$("input[type='text']"),this},clear:function(){this.model.destroy()},increase:function(){this.model.increase()},decrease:function(){this.model.decrease()},setAmount:function(){var e=this.$input.val();this.model.setAmount(e)}}),l=r.View.extend({el:n("#cart"),events:{"click .b-yellow":"submit"},initialize:function(){this.listenTo(a,"add",this.addToCart),this.listenTo(a,"add remove change sync",this.renderCart),this.$cartNumber=n("#cartNumber"),this.$emptyAttention=this.$(".empty"),this.$total=this.$(".op-settlement em"),this.$cartState=this.$(".op-settlement"),this.$submit=this.$(".b-yellow"),this.$form=this.$("form"),this.$data=this.$('input[type="hidden"]'),a.fetch()},submit:function(){if(a.length>0){var e=[];a.each(function(t){var n={};n.id=t.get("id"),n.goods_name=t.get("goods_name"),n.amount=t.get("amount"),n.goods_barcode=t.get("goods_barcode"),n.goods_active_price=t.get("goods_active_price"),e.push(n)}),this.$data.val(JSON.stringify(e)),this.$form.submit()}},addToCart:function(e){var t=new f({model:e});this.$("#cart-item-list").append(t.render().el)},renderCart:function(){this.$cartNumber.text(a.length),a.length>0?(this.$emptyAttention.hide(),this.$cartState.show()):(this.$emptyAttention.show(),this.$cartState.hide()),this.$total.text("￥"+a.calc()),this.$submit.text("结算("+a.length+")件")}});new l,t.exports=a})